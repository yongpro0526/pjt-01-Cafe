<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miniproject.cafe.Mapper.MenuMapper">


    <!-- 1) 지점 전체 메뉴 조회 (관리자 전용) -->
    <select id="getMenuByStore" resultType="com.miniproject.cafe.VO.MenuVO">
        SELECT
            MENU_ID AS menuId,
            MENU_NAME AS menuName,
            CATEGORY AS category,
            SALES_STATUS AS salesStatus,
            MENU_IMG AS menuImg,
            MENU_PRICE AS menuPrice,
            HOT_AVAILABLE AS hotAvailable,
            MENU_DEFINITION AS menuDefinition,
            STORE_NAME AS storeName
        FROM MENU
        WHERE STORE_NAME = #{storeName}
        ORDER BY
            CASE WHEN SALES_STATUS = '판매중' THEN 0 ELSE 1 END,
            MENU_NAME ASC
    </select>

    <!-- 2) 지점 + 카테고리 조회 (사용자용) -->
    <select id="getMenuByStoreAndCategory" resultType="com.miniproject.cafe.VO.MenuVO">
        SELECT
            MENU_ID AS menuId,
            MENU_NAME AS menuName,
            CATEGORY AS category,
            SALES_STATUS AS salesStatus,
            MENU_IMG AS menuImg,
            MENU_PRICE AS menuPrice,
            HOT_AVAILABLE AS hotAvailable,
            MENU_DEFINITION AS menuDefinition,
            STORE_NAME AS storeName
        FROM MENU
        WHERE STORE_NAME = #{storeName}
          AND CATEGORY = #{category}
        ORDER BY
            CASE WHEN SALES_STATUS = '판매중' THEN 0 ELSE 1 END,
            MENU_NAME ASC
    </select>


    <!-- 3) 메뉴 단일 조회 -->
    <select id="getMenuById" resultType="com.miniproject.cafe.VO.MenuVO">
        SELECT
            MENU_ID AS menuId,
            MENU_NAME AS menuName,
            CATEGORY AS category,
            SALES_STATUS AS salesStatus,
            MENU_IMG AS menuImg,
            MENU_PRICE AS menuPrice,
            HOT_AVAILABLE AS hotAvailable,
            MENU_DEFINITION AS menuDefinition,
            STORE_NAME AS storeName
        FROM MENU
        WHERE MENU_ID = #{menuId}
    </select>


    <update id="updateMenu" parameterType="com.miniproject.cafe.VO.MenuVO">
        UPDATE MENU
        SET
            MENU_NAME = #{menuName},
            CATEGORY = #{category},
            MENU_PRICE = #{menuPrice},
            HOT_AVAILABLE = #{hotAvailable},
            MENU_DEFINITION = #{menuDefinition},
            SALES_STATUS = #{salesStatus},
            MENU_IMG = #{menuImg}
        WHERE MENU_ID = #{menuId}
          AND STORE_NAME = #{storeName}
    </update>


    <!-- 4) 메뉴 INSERT -->
    <insert id="insertMenu" parameterType="com.miniproject.cafe.VO.MenuVO">
        INSERT INTO MENU (
            MENU_ID,
            MENU_NAME,
            CATEGORY,
            SALES_STATUS,
            MENU_IMG,
            MENU_PRICE,
            HOT_AVAILABLE,
            MENU_DEFINITION,
            STORE_NAME
        ) VALUES (
                     #{menuId},
                     #{menuName},
                     #{category},
                     #{salesStatus},
                     #{menuImg},
                     #{menuPrice},
                     #{hotAvailable},
                     #{menuDefinition},
                     #{storeName}
                 )
    </insert>

    <!-- 5) 지점 검증 후 삭제 (안전 삭제) -->
    <delete id="deleteMenuByStore">
        DELETE FROM MENU
        WHERE MENU_ID = #{menuId}
          AND STORE_NAME = #{storeName}
    </delete>

    <select id="getLastMenuIdByStore" parameterType="string" resultType="string">
        SELECT MENU_ID
        FROM MENU
        WHERE STORE_NAME = #{storeName}
        ORDER BY MENU_ID DESC
            LIMIT 1
    </select>

    <update id="updateSalesStatus">
        UPDATE menu
        SET SALES_STATUS = #{salesStatus}
        WHERE MENU_ID = #{menuId}
          AND STORE_NAME = #{storeName}
    </update>


</mapper>