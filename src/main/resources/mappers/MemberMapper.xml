<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miniproject.cafe.Mapper.MemberMapper">

    <insert id="registerMember" parameterType="MemberVO">
        INSERT INTO member(
        ID,
        EMAIL,
        PASSWORD,
        USERNAME,
        PROVIDER)
        VALUES (
        #{id},
        #{email},
        #{password},
        #{username},
        #{provider}
        )
    </insert>

    <select id="loginMember" parameterType="MemberVO" resultType="MemberVO">
        SELECT *
        FROM MEMBER
        WHERE EMAIL = #{email}
    </select>

    <select id="isEmailDuplicate" parameterType="String" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM MEMBER
        WHERE email = #{email}
    </select>

    <select id="isIdDuplicate" parameterType="String" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM MEMBER
        WHERE ID = #{id}
    </select>

    <insert id="insertOAuthMember" parameterType="MemberVO">
        INSERT INTO MEMBER(
            ID,
            EMAIL,
            USERNAME,
            PASSWORD,
            PROVIDER
        )
        VALUES (
                   #{id},
                   #{email},
                   #{username},
                   #{password},
                   #{provider}
               )
    </insert>

    <update id="updateUser" parameterType="MemberVO">
        UPDATE MEMBER
        SET
            USERNAME = #{username}
        WHERE ID = #{id}
    </update>
    <!-- 이메일로 회원 조회 -->
    <select id="findByEmail" parameterType="string" resultType="MemberVO">
        SELECT *
        FROM MEMBER
        WHERE EMAIL = #{email}
    </select>

    <!-- 자동로그인 토큰 저장 -->
    <update id="saveRememberMeToken">
        UPDATE MEMBER
        SET REMEMBER_TOKEN = #{token},
            TOKEN_EXPIRY = #{expiry}
        WHERE ID = #{memberId}
    </update>

    <!-- 자동로그인 토큰으로 회원 조회 -->
    <select id="findByRememberMeToken" resultType="MemberVO">
        SELECT *
        FROM MEMBER
        WHERE REMEMBER_TOKEN = #{token}
          AND TOKEN_EXPIRY > NOW()
    </select>

    <!-- 자동로그인 해제 -->
    <update id="clearRememberMeToken">
        UPDATE MEMBER
        SET REMEMBER_TOKEN = NULL,
            TOKEN_EXPIRY = NULL
        WHERE ID = #{memberId}
    </update>

</mapper>