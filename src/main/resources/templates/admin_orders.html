<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 주문 목록 (Dynamic) - Java Cafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>

<script th:inline="javascript">
    const storeName = /*[[${session.admin.storeName}]]*/ "";
</script>

<th:block th:replace="~{./include/adminBaseLayout :: setContent( ~{:: .wrap} ) }">

    <div class="wrap">
        <div class="notification-icon" id="notification-trigger">
            <div class="notification-popup" id="notification-popup">
                <div class="popup-arrow"></div> <p>주문내역이 없습니다.</p>
            </div>
        </div>

        <main class="main-content">
            <h2 class="main-title">주문 목록</h2>

            <div class="order-grid" id="order-grid-container">
            </div>
            <div id="empty-orders" class="order-grid-empty">
                현재 접수된 주문이 없습니다.
            </div>
        </main>
    </div>
</th:block>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const API_BASE_URL = '/api/orders';
        const API_ENDPOINT_LIST = `${API_BASE_URL}/admin-list?storeName=${storeName}`;
        const API_ENDPOINT_STATUS_UPDATE = `${API_BASE_URL}/status`;

        const orderGrid = document.getElementById('order-grid-container');
        const notificationTrigger = document.getElementById('notification-trigger');
        const notificationPopup = document.getElementById('notification-popup');

        // ✅ 이 세션에서 "완료/취소 처리한 주문" ID를 보관하는 Set
        const removedOrderIds = new Set();

        // ---------------------------
        // 1. 초기 주문 목록 1회 로딩
        // ---------------------------
        async function loadInitialOrders() {
            try {
                const response = await fetch(API_ENDPOINT_LIST, { cache: 'no-store' });
                if (!response.ok) throw new Error(response.status);

                const orders = await response.json();
                renderOrders(orders);

            } catch (e) {
                console.error('초기 주문 로딩 실패:', e);
                orderGrid.innerHTML = `<div class="order-grid-empty">주문 목록 로딩 실패 (${e.message})</div>`;
            }
        }

        // ---------------------------
        // 2. 주문 렌더링 함수
        // ---------------------------
        function renderOrders(orders) {
            orderGrid.innerHTML = '';

            /*if (!orders || orders.length === 0) {
                orderGrid.innerHTML = '<div class="order-grid-empty">현재 접수된 주문이 없습니다.</div>';
                return;
            }*/
            orders.forEach(order => {
                orderGrid.insertAdjacentHTML('beforeend', createOrderCard(order));
                const card = document.getElementById(`order-card-${order.orderId}`);

                if (card) {
                    setTimeout(() => {
                        card.classList.add('show');
                    }, 10);
                }
            });
            updateEmptyState();
        }

        //주문이 없을때
        function updateEmptyState() {
            const emptyBox = document.getElementById('empty-orders');
            if (!orderGrid || !emptyBox) return;
            const hasCards = orderGrid.children.length > 0;
            if (hasCards) {
                emptyBox.style.display = "none";
            } else {
                emptyBox.style.display = "block";
            }
        }


        // ---------------------------
        // 3. SSE 연결
        // ---------------------------
        function connectSSE(storeName) {

            const eventSource = new EventSource(`/sse/subscribe/${storeName}`);

            // 주문 이벤트
            eventSource.addEventListener("order", (event) => {

                const order = JSON.parse(event.data);
                const idStr = String(order.orderId);

                // ✅ 이 세션에서 이미 완료/취소로 처리한 주문이면 무시
                if (removedOrderIds.has(idStr)) {
                    return;
                }

                // ✅ 이미 화면에 같은 카드가 있다면(중복 방지) 무시
                if (document.getElementById(`order-card-${order.orderId}`)) {
                    return;
                }

                // 화면 최상단에 추가
                insertCardToTop(createOrderCard(order), order.orderId);
                updateEmptyState();

                // 팝업 알림 표시
                showNotification("새로운 주문이 도착했습니다!");
            });

            // 오류 발생 시 재연결
            eventSource.onerror = () => {
                console.error("SSE 오류 발생 → 3초 후 재연결 시도");
                eventSource.close();
                setTimeout(() => connectSSE(storeName), 3000);
            };
        }

        // ---------------------------
        // 4. 주문 카드 생성
        // ---------------------------
        function createOrderCard(order) {

            let cardTypeClass = 'type-default';
            if (order.orderType === '매장') cardTypeClass = 'type-store';
            else if (order.orderType === '포장') cardTypeClass = 'type-takeout';
            else if (order.orderType === '배달') cardTypeClass = 'type-delivery';

            const menuItemsHtml = (order.orderItemList || []).map(item => {

                const tumblerTxt = item.tumbler === 1 ? "텀블러" : "일반컵";
                const tempTxt = item.temp ? item.temp.toUpperCase() : "";
                const shotTxt = item.shot > 0 ? `샷 : ${item.shot}` : "";
                const syrupTxt = item.vanillaSyrup > 0 ? `시럽 : ${item.vanillaSyrup}` : "";
                const creamTxt = item.whippedCream > 0 ? `휘핑크림` : "";

                const optionsText = [
                    tumblerTxt,
                    tempTxt,
                    shotTxt,
                    syrupTxt,
                    creamTxt
                ]
                    .filter(v => v !== "")
                    .join("<br>");

                return `
                <li>
                    <div class="menu-item-name">
                        ${item.menuItemName}
                        <span>${item.quantity}</span>
                    </div>
                    <div class="menu-options" style="line-height: 1.4">${optionsText}</div>
                </li>
                `;
            }).join('');

            let formattedTime = '00:00';
            if (order.orderTime) {
                try {
                    const date = new Date(order.orderTime);
                    formattedTime = `${date.getHours()}시 ${String(date.getMinutes()).padStart(2, '0')}분`;
                } catch {
                    formattedTime = "시간 오류";
                }
            }

            const formattedDailyId = `#${String(order.dailyOrderNum).padStart(4, '0')}`;
            const nickname = order.username || "이름없음";

            return `
            <div class="order-card ${cardTypeClass}" id="order-card-${order.orderId}">

                <div>
                    <div class="card-header">
                        <span class="order-id">${formattedDailyId}</span>
                        <span class="order-time">${formattedTime}</span>
                    </div>

                    <div class="option-info">
                        <div><strong>주문자:</strong> ${nickname}</div>
                    </div>

                    <ul class="menu-list">
                        ${menuItemsHtml}
                    </ul>
                </div>

                <div>
                    <div class="request-text">
                        <strong>요청사항:</strong> ${order.requestText ? order.requestText : '없음'}
                    </div>
                    <div class="card-footer-row">
                        <span>총 수량</span>
                        <span>${order.totalQuantity}</span>
                    </div>

                    <div class="card-footer-total">
                        <span>${order.orderType}</span>
                        <span>${order.totalPrice.toLocaleString('ko-KR')}원</span>
                    </div>
                </div>

                <button class="card-menu-button" data-order-id="${order.orderId}">⋮</button>
                <div class="card-menu-dropdown" id="menu-dropdown-${order.orderId}">
                    <button class="complete" data-status="주문완료">✔ 완료</button>
                    <button class="cancel" data-status="주문취소">✖ 취소</button>
                </div>
            </div>`;
        }

        // ---------------------------
        // 5. 알림 팝업
        // ---------------------------
        function showNotification(message) {
            notificationPopup.querySelector('p').innerText = message;
            notificationPopup.classList.add('show');

            setTimeout(() => {
                notificationPopup.classList.remove('show');
            }, 3000);
        }

        // ---------------------------
        // 6. 주문 상태 변경
        // ---------------------------
        async function handleUpdateStatus(orderId, status) {

            try {
                const response = await fetch(`${API_ENDPOINT_STATUS_UPDATE}/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (!response.ok) throw new Error(response.status);

                // ✅ 이 세션에서 제거된 주문으로 표시
                removedOrderIds.add(String(orderId));

                // ✅ 카드 제거 애니메이션
                removeOrderCard(orderId);

            } catch (e) {
                alert(`상태 변경 실패 (${e.message})`);
            }
        }

        // ---------------------------
        // 7. 이벤트 위임(버튼 클릭)
        // ---------------------------
        orderGrid.addEventListener('click', event => {
            const target = event.target;

            if (target.classList.contains('card-menu-button')) {
                event.stopPropagation();
                const orderId = target.dataset.orderId;
                const dropdown = document.getElementById(`menu-dropdown-${orderId}`);

                document.querySelectorAll('.card-menu-dropdown.show').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });

                dropdown.classList.toggle('show');
            }

            if (target.matches('.card-menu-dropdown button')) {
                event.stopPropagation();
                const dropdown = target.closest('.card-menu-dropdown');
                const orderId = dropdown.previousElementSibling.dataset.orderId;
                const status = target.dataset.status;

                dropdown.classList.remove('show');
                handleUpdateStatus(orderId, status);
            }
        });

        // ---------------------------
        // 8. 카드 상단 삽입 (새 주문)
        // ---------------------------
        function insertCardToTop(html, orderId) {
            orderGrid.insertAdjacentHTML('afterbegin', html);

            const card = document.getElementById(`order-card-${orderId}`);
            setTimeout(() => {
                card.classList.add("show");
            }, 10);
        }

        // ---------------------------
        // 9. 카드 제거 애니메이션
        // ---------------------------
        function removeOrderCard(orderId) {
            const card = document.getElementById(`order-card-${orderId}`);
            if (!card) return;

            card.classList.add("hide");

            setTimeout(() => {
                card.remove();
                updateEmptyState();
            }, 350);
        }

        // ---------------------------
        // 10. 초기 실행
        // ---------------------------
        loadInitialOrders();      // 초기 목록 1회 로딩
        connectSSE(storeName);    // SSE 연결

    });

    document.querySelectorAll(".complete").forEach(button => {
        button.addEventListener("click", function() {
            const orderId = this.closest(".card-menu-dropdown").id.split("-")[2]; // dropdown-${orderId}에서 orderId 추출
            const status = this.dataset.status; // "주문완료"

            fetch(`/api/orders/status/${orderId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: status })
            })
                .then(res => {
                    if(res.ok){
                        alert("주문 완료 처리됨!");
                        // ① 현재 주문관리 페이지 새로고침 또는 업데이트
                        // ② 매출페이지에 반영
                        updateRevenuePage();
                    }
                });
        });
    });

</script>


</html>