<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miniproject.cafe.Mapper.CartMapper">

    <!-- ðŸ”¥ ê¸°ì¡´ CartVOë¥¼ ì‚¬ìš©í•˜ëŠ” insertCart -->
    <insert id="insertCart" parameterType="CartVO">
        INSERT INTO CART(MEMBER_ID, TOTAL_PRICE)
        VALUES(#{memberId}, #{totalPrice})
    </insert>

    <!-- ðŸ”¥ Mapì„ ì‚¬ìš©í•˜ëŠ” insertCartëŠ” ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ -->
    <insert id="insertCartByMap" parameterType="map">
        INSERT INTO CART (MEMBER_ID, TOTAL_PRICE)
        VALUES (#{memberId}, 0)
    </insert>

    <select id="getCartList" parameterType="String" resultType="map">
        SELECT
            C.CART_ID,
            C.MEMBER_ID,
            COALESCE(C.TOTAL_PRICE, 0) as TOTAL_PRICE,
            CI.CART_ITEM_ID,
            COALESCE(CI.QUANTITY, 0) as QUANTITY,
            MO.OPTION_ID,
            MO.TEMP,
            COALESCE(MO.TUMBLER_USE, false) as TUMBLER_USE,
            COALESCE(MO.SHOT_COUNT, 0) as SHOT_COUNT,
            COALESCE(MO.VANILLA_SYRUP_COUNT, 0) as VANILLA_SYRUP_COUNT,
            COALESCE(MO.WHIPPED_CREAM_COUNT, 0) as WHIPPED_CREAM_COUNT,
            M.MENU_ID,
            M.MENU_NAME,
            COALESCE(M.MENU_PRICE, 0) as MENU_PRICE,
            M.MENU_IMG
        FROM CART C
                 LEFT JOIN CART_ITEM CI ON C.CART_ID = CI.CART_ID
                 LEFT JOIN MENU_OPTION MO ON CI.MENU_OPTION_ID = MO.OPTION_ID
                 LEFT JOIN MENU M ON MO.MENU_ID = M.MENU_ID
        WHERE C.MEMBER_ID = #{memberId}
        ORDER BY CI.CART_ITEM_ID DESC
    </select>

    <insert id="addCartItem" parameterType="CartItemVO">
        INSERT INTO CART_ITEM (CART_ID, MENU_OPTION_ID, QUANTITY)
        VALUES (#{cartId}, #{menuOptionId}, #{quantity})
    </insert>

    <delete id="deleteCartItem">
        DELETE FROM CART_ITEM
        WHERE CART_ITEM_ID = #{cartItemId}
    </delete>

    <update id="changeQuantityCartItem">
        UPDATE CART_ITEM
        SET QUANTITY = #{quantity}
        WHERE CART_ITEM_ID = #{cartItemId}
    </update>

    <!-- íšŒì› ìž¥ë°”êµ¬ë‹ˆ ì¡°íšŒ -->
    <select id="findCartByMemberId" parameterType="String" resultType="Long">
        SELECT CART_ID FROM CART WHERE MEMBER_ID = #{memberId}
    </select>

    <!-- ë©”ë‰´ ì˜µì…˜ ì¡°íšŒ -->
    <select id="findMenuOption" parameterType="map" resultType="Long">
        SELECT OPTION_ID
        FROM MENU_OPTION
        WHERE MENU_ID = #{menuId}
          AND TEMP = #{temp}
          AND TUMBLER_USE = #{tumblerUse}
          AND SHOT_COUNT = #{shotCount}
          AND VANILLA_SYRUP_COUNT = #{vanillaSyrupCount}
          AND WHIPPED_CREAM_COUNT = #{whippedCreamCount}
    </select>

    <!-- ë©”ë‰´ ì˜µì…˜ ìƒì„± -->
    <insert id="insertMenuOption" parameterType="map" useGeneratedKeys="true" keyProperty="optionId">
        INSERT INTO MENU_OPTION (MENU_ID, TEMP, TUMBLER_USE, SHOT_COUNT, VANILLA_SYRUP_COUNT, WHIPPED_CREAM_COUNT)
        VALUES (#{menuId}, #{temp}, #{tumblerUse}, #{shotCount}, #{vanillaSyrupCount}, #{whippedCreamCount})
    </insert>

    <select id="findExistingCartItem" resultType="Long">
        SELECT CART_ITEM_ID
        FROM CART_ITEM
        WHERE CART_ID = #{cartId} AND MENU_OPTION_ID = #{menuOptionId}
    </select>

    <select id="getCartItem" resultType="CartItemVO">
        SELECT *
        FROM CART_ITEM
        WHERE CART_ITEM_ID = #{cartItemId}
    </select>

</mapper>