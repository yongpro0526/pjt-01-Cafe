<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 주문 목록 (Dynamic) - Java Cafe</title>
    <!-- 폰트 로드 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #F5F0E8; /* bg-light-beige */
            color: #6B4F3B; /* text-main-brown */
            line-height: 1.5;
            overflow-x: hidden;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* --- 색상 변수 --- */
        :root {
            --main-brown: #6B4F3B;
            --card-green: #AEC69F;
            --card-yellow: #F8D58B;
            --card-blue: #A9C8E8;
            --active-orange: #F9A825;
            --hover-orange: #FBC02D;
            --top-bar-bg: #F8C79D;
            --top-bar-text: #5A3E2B;
        }

        /* --- 레이아웃 --- */
        .wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #F5F0E8;
        }

        /* --- 상단 바 --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--top-bar-bg);
            height: 60px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .top-bar .logo-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-bar .logo-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .top-bar .logo-text {
            font-size: 22px;
            font-weight: bold;
            color: var(--top-bar-text);
        }

        .top-bar .notification-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            color: var(--top-bar-text);
        }

        /* 알림 팝업 */
        .notification-popup {
            display: none;
            position: absolute;
            top: calc(100% + 15px);
            right: -10px;
            width: 220px;
            padding: 1rem;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            color: #555;
            font-size: 0.9rem;
            text-align: center;
        }

        .notification-popup.show {
            display: block;
        }

        .notification-popup .popup-arrow {
            position: absolute;
            top: -10px;
            right: 18px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #ffffff;
            filter: drop-shadow(0 -1px 0.5px #e0e0e0);
        }

        /* --- 메인 컨텐츠 --- */
        .main-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--main-brown);
            text-align: center;
            margin-bottom: 2rem;
        }

        /* --- 주문 그리드 --- */
        .order-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            width: 100%;
        }

        .order-grid-empty {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--main-brown);
            opacity: 0.7;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
        }

        @media (min-width: 768px) {
            .order-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* --- 주문 카드 --- */
        .order-card {
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .order-card.type-store { background-color: var(--card-green); }
        .order-card.type-takeout { background-color: var(--card-yellow); }
        .order-card.type-delivery { background-color: var(--card-blue); }
        .order-card.type-default { background-color: #ddd; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-right: 40px;
        }

        .order-id {
            background-color: white;
            color: var(--main-brown);
            font-size: 1.125rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: 1px solid #eee;
        }

        .order-time {
            font-size: 1.125rem;
            font-weight: 600;
            margin-right: 10px;
        }

        .menu-list {
            list-style: none;
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .menu-list li {
            margin-bottom: 0.25rem;
        }

        .menu-list span {
            float: right;
        }

        .card-footer-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .card-footer-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* ... 버튼 */
        .card-menu-button {
            position: absolute;
            top: 1.5rem;
            right: 1rem;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 30px;
            text-align: center;
            color: inherit;
            padding-bottom: 10px;
        }
        .card-menu-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* 드롭다운 */
        .card-menu-dropdown {
            display: none;
            position: absolute;
            top: 45px;
            right: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 10;
            overflow: hidden;
            width: 100px;
        }
        .card-menu-dropdown.show {
            display: block;
        }
        .card-menu-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            font-size: 0.9rem;
            color: #333;
        }
        .card-menu-dropdown button:hover {
            background-color: #f4f4f4;
        }
        .card-menu-dropdown button.complete {
            color: #27ae60;
        }
        .card-menu-dropdown button.cancel {
            color: #e74c3c;
        }

        /* --- 하단 네비게이션 --- */
        .footer-nav {
            background-color: var(--main-brown);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .footer-nav-item {
            flex: 1;
            padding: 2rem 0;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .footer-nav-item.active {
            background-color: var(--active-orange);
        }

        .footer-nav-item:not(.active):hover {
            background-color: var(--hover-orange);
        }

    </style>
</head>
<body>

<div class="wrapper">

    <header class="top-bar">
        <div class="logo-section">
            <span class="logo-icon">☕</span>
            <span class="logo-text">JavaBean</span>
        </div>
        <div class="notification-icon" id="notification-trigger">
            <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;">
                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
            </svg>
            <div class="notification-popup" id="notification-popup">
                <div class="popup-arrow"></div> <p>주문내역이 없습니다.</p>
            </div>
        </div>
    </header>

    <main class="main-content">
        <h2 class="main-title">주문 목록</h2>

        <div class="order-grid" id="order-grid-container">
            <!-- 주문 카드가 여기에 동적으로 삽입됩니다. -->
        </div>
    </main>

    <footer class="footer-nav">
        <a href="#" class="footer-nav-item">메뉴 관리</a>
        <a href="#" class="footer-nav-item active">주문 관리</a>
        <a href="#" class="footer-nav-item">매출 관리</a>
        <a href="#" class="footer-nav-item">로그인</a>
    </footer>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 상수 및 변수 정의 ---

        const API_BASE_URL = 'http://localhost:8383/api/orders';
        const API_ENDPOINT_LIST = `${API_BASE_URL}/admin-list`;
        const API_ENDPOINT_STATUS_UPDATE = `${API_BASE_URL}/status`;

        const POLLING_INTERVAL = 3000;
        let pollingTimer = null;

        const orderGrid = document.getElementById('order-grid-container');
        const notificationTrigger = document.getElementById('notification-trigger');
        const notificationPopup = document.getElementById('notification-popup');


        // API에서 주문 데이터를 가져와 화면에 렌더링
        async function fetchAndRenderOrders() {
            try {
                const response = await fetch(API_ENDPOINT_LIST, { cache: 'no-store' });

                if (!response.ok) {
                    throw new Error(`[1] HTTP error! status: ${response.status}`);
                }

                const orders = await response.json();
                renderOrders(orders);

            } catch (error) {
                console.error('주문 목록을 가져오는 데 실패했습니다:', error);
                orderGrid.innerHTML = `<div class="order-grid-empty">주문 목록 로딩 오류. (${error.message})</div>`;
            }
        }

        // 주문 배열을 받아 화면에 렌더링
        function renderOrders(orders) {
            orderGrid.innerHTML = '';

            if (!orders || orders.length === 0) {
                orderGrid.innerHTML = '<div class="order-grid-empty">현재 접수된 주문이 없습니다.</div>';
            } else {
                orders.forEach(order => {
                    const cardHtml = createOrderCard(order);
                    orderGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        }


        // 주문 객체(order)를 받아 HTML 카드 문자열을 생성
        function createOrderCard(order) {
            // 1. 주문 유형(orderType)에 따른 CSS 클래스 결정
            let cardTypeClass = 'type-default';
            if (order.orderType === '매장') cardTypeClass = 'type-store';
            else if (order.orderType === '포장') cardTypeClass = 'type-takeout';
            else if (order.orderType === '배달') cardTypeClass = 'type-delivery';

            // 2. 주문 아이템 목록(orderItemList)을 <li> 태그로 변환
            const menuItemsHtml = (order.orderItemList && Array.isArray(order.orderItemList))
                ? order.orderItemList.map(item => `
                    <li>${item.menuItemName || '알 수 없는 메뉴'} <span>${item.quantity || 0}</span></li>
                `).join('')
                : '';

            // 3. orderTime (DATETIME)을 "HH시 mm분"으로 포맷팅
            let formattedTime = '00:00';
            if (order.orderTime) {
                try {
                    const date = new Date(order.orderTime);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    formattedTime = `${hours}시 ${minutes}분`;
                } catch (e) {
                    console.error("시간 포맷팅 오류", e);
                    formattedTime = "시간오류";
                }
            }

            // 4. [수정] 포맷팅 대상을 order.orderId -> order.dailyOrderNum으로 변경
            //    (dailyOrderNum은 OrderVO에 새로 추가된 Long 필드입니다)
            const formattedDailyId = `#${String(order.dailyOrderNum || 0).padStart(4, '0')}`;

            // 5. 카드 템플릿
            //    [중요] .order-id에는 포맷팅된 '일일 번호' (formattedDailyId)를 표시
            //    [중요] 버튼의 data-order-id에는 DB의 '실제 ID' (order.orderId)를 저장
            return `
                <div class="order-card ${cardTypeClass}" id="order-card-${order.orderId}">
                    <div>
                        <div class="card-header">
                            <!-- [수정] 표시되는 ID를 일일 번호로 변경 -->
                            <span class="order-id">${formattedDailyId}</span>
                            <span class="order-time">${formattedTime}</span>
                        </div>
                        <ul class="menu-list">
                            ${menuItemsHtml}
                        </ul>
                    </div>
                    <div>
                        <div class="card-footer-row">
                            <span>총 수량</span>
                            <span>${order.totalQuantity || 0}</span>
                        </div>
                        <div class="card-footer-total">
                            <span>${order.orderType || '알 수 없음'}</span>
                            <span>${(order.totalPrice || 0).toLocaleString('ko-KR')}원</span>
                        </div>
                    </div>

                    <!--
                      [중요]
                      버튼의 data-order-id는 "완료/취소" API가 호출할
                      DB의 실제 PK (예: 501)를 저장해야 합니다.
                    -->
                    <button class="card-menu-button" data-order-id="${order.orderId}">⋮</button>
                    <div class="card-menu-dropdown" id="menu-dropdown-${order.orderId}">
                        <button class="complete" data-status="주문완료">✔ 완료</button>
                        <button class="cancel" data-status="주문취소">✖ 취소</button>
                    </div>
                </div>
            `;
        }

        /**
         * 주문 상태 업데이트 (완료/취소)
         */
        async function handleUpdateStatus(orderId, status) {

            clearInterval(pollingTimer); // 레이스 컨디션 방지

            try {
                const response = await fetch(`${API_ENDPOINT_STATUS_UPDATE}/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (!response.ok) {
                    throw new Error(`[3] 서버 응답 오류: ${response.status}`);
                }

                // DB에서 확인된 최신 목록으로 새로고침
                await fetchAndRenderOrders();

            } catch (error) {
                console.error('상태 변경 실패:', error);
                alert(`[4] 상태 변경에 실패했습니다. (${error.message})\n목록을 새로고침합니다.`);
                await fetchAndRenderOrders();
            } finally {
                startPolling(); // 타이머 재시작
            }
        }


        // --- 이벤트 리스너 및 초기화 ---

        // 1. 알림 팝업 토글
        notificationTrigger.addEventListener('click', (event) => {
            event.stopPropagation();
            notificationPopup.classList.toggle('show');
        });

        // 2. 팝업 외부 클릭 시 팝업 닫기
        document.addEventListener('click', (event) => {
            if (notificationPopup.classList.contains('show') && !notificationTrigger.contains(event.target)) {
                notificationPopup.classList.remove('show');
            }

            document.querySelectorAll('.card-menu-dropdown.show').forEach(dropdown => {
                if (!dropdown.previousElementSibling.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // 3. 주문 그리드 이벤트 위임
        orderGrid.addEventListener('click', (event) => {
            const target = event.target;

            // (A) ... 메뉴 버튼 클릭 시
            if (target.classList.contains('card-menu-button')) {
                event.stopPropagation();
                // [중요] data-order-id는 DB의 실제 ID (Long)
                const orderId = target.dataset.orderId;
                const dropdown = document.getElementById(`menu-dropdown-${orderId}`);

                document.querySelectorAll('.card-menu-dropdown.show').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });
                dropdown.classList.toggle('show');
            }

            // (B) 드롭다운 메뉴 (완료/취소) 클릭 시
            if (target.matches('.card-menu-dropdown button')) {
                event.stopPropagation();
                const dropdown = target.closest('.card-menu-dropdown');
                // [중요] data-order-id는 DB의 실제 ID (Long)
                const orderId = dropdown.previousElementSibling.dataset.orderId;
                const status = target.dataset.status;

                dropdown.classList.remove('show');

                handleUpdateStatus(orderId, status);
            }
        });

        // 타이머 시작/정지 함수화
        function startPolling() {
            clearInterval(pollingTimer);
            pollingTimer = setInterval(fetchAndRenderOrders, POLLING_INTERVAL);
        }

        // 4. 페이지 로드 시 즉시 주문 목록 가져오기
        fetchAndRenderOrders();

        // 5. (실시간 업데이트) 타이머 시작
        startPolling();

        console.log(`Admin Order Page script loaded. Polling every ${POLLING_INTERVAL / 1000} seconds.`);
    });
</script>

</body>
</html>